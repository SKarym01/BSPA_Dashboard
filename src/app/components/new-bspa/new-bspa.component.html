<div class="min-h-screen bg-slate-50 text-slate-800 font-sans pb-20">

    <!-- WORKFLOW STEPPER -->
    <div class="max-w-5xl mx-auto mb-10 px-4 pt-8">
        <div class="relative flex justify-between items-center">
            <!-- Connecting Line -->
            <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-200 -z-10"></div>
            <!-- Steps -->
            <!-- Step 1: Upload -->
            <div class="flex flex-col items-center gap-2 bg-slate-50 px-2 z-10 cursor-pointer group"
                (click)="setStep('CUSTOMER_DATA')">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300 font-bold text-sm shadow-sm"
                    [ngClass]="currentStep === 'CUSTOMER_DATA' ? 'border-blue-500 bg-blue-50 text-blue-600 scale-110' : 'border-slate-300 bg-white text-slate-400'">
                    1
                </div>
                <span class="text-xs font-bold uppercase tracking-wider"
                    [ngClass]="currentStep === 'CUSTOMER_DATA' ? 'text-blue-600' : 'text-slate-400'">
                    Upload
                </span>
            </div>
            <!-- Step 2: Validation -->
            <div class="flex flex-col items-center gap-2 bg-slate-50 px-2 z-10 cursor-pointer group"
                (click)="setStep('INPUT_SHEET')">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300 font-bold text-sm shadow-sm"
                    [ngClass]="['INPUT_SHEET'].includes(currentStep) ? 'border-blue-500 bg-blue-50 text-blue-600 scale-110' : 'border-slate-300 bg-white text-slate-400'">
                    2
                </div>
                <span class="text-xs font-bold uppercase tracking-wider"
                    [ngClass]="['INPUT_SHEET'].includes(currentStep) ? 'text-blue-600' : 'text-slate-400'">
                    Validation
                </span>
            </div>
            <!-- Step 3: Simulation -->
            <div class="flex flex-col items-center gap-2 bg-slate-50 px-2 z-10 cursor-pointer group"
                (click)="currentStep === 'MAMBA' ? null : null">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300 font-bold text-sm shadow-sm"
                    [ngClass]="currentStep === 'MAMBA' ? 'border-blue-500 bg-blue-50 text-blue-600 scale-110' : 'border-slate-300 bg-white text-slate-400'">
                    3
                </div>
                <span class="text-xs font-bold uppercase tracking-wider"
                    [ngClass]="currentStep === 'MAMBA' ? 'text-blue-600' : 'text-slate-400'">
                    Simulation
                </span>
            </div>
            <!-- Step 4: Results -->
            <div class="flex flex-col items-center gap-2 bg-slate-50 px-2 z-10 cursor-pointer group">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300 font-bold text-sm shadow-sm"
                    [ngClass]="currentStep === 'RESULTS' ? 'border-blue-500 bg-blue-50 text-blue-600 scale-110' : 'border-slate-300 bg-white text-slate-400'">
                    4
                </div>
                <span class="text-xs font-bold uppercase tracking-wider"
                    [ngClass]="currentStep === 'RESULTS' ? 'text-blue-600' : 'text-slate-400'">
                    Results
                </span>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <main class="max-w-6xl mx-auto px-4">

        <!-- ========================================== -->
        <!-- STEP 1: EPC INPUT & UPLOAD -->
        <!-- ========================================== -->
        <section *ngIf="currentStep === 'CUSTOMER_DATA'"
            class="animate-slide-up modern-panel p-10 min-h-[500px] flex flex-col items-center bg-white relative overflow-hidden">
            <div class="mb-10 z-10 text-center">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">Project Setup</h2>
                <p class="text-slate-500 text-lg">Enter EPC Number (Detailed view) and upload your parameter sheet.</p>
            </div>
            <!-- EPC Input -->
            <div class="w-full max-w-md mb-8 relative z-10">
                <label class="block text-sm font-bold text-slate-700 mb-2">EPC Number (Optional)</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <input type="text" [(ngModel)]="epcNumber" placeholder="e.g. EPC-2024-001"
                        class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm" />
                </div>
                <p class="text-xs text-slate-400 mt-1 ml-1" *ngIf="!epcNumber">Enter EPC to enable detailed tracking.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-2xl relative z-10">
                <!-- Upload Card -->
                <div class="modern-card p-8 flex flex-col items-center gap-4 cursor-pointer hover:border-blue-400 group h-full"
                    (click)="uploadFile()">
                    <div
                        class="w-16 h-16 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300 shadow-sm border border-blue-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" x2="12" y1="3" y2="15" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 text-center">Upload Parameters</h3>
                        <p class="text-sm text-slate-500 mt-1 text-center">Import .xlsx or .xlsm file</p>
                    </div>
                    <input #fileInput type="file" class="hidden" (change)="onFileSelected($event)"
                        accept=".xlsx, .xlsm" />
                </div>

                <!-- Manual Card -->
                <div class="modern-card p-8 flex flex-col items-center gap-4 cursor-pointer hover:border-cyan-400 group h-full bg-slate-50/50"
                    (click)="nextStep()">
                    <div
                        class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-cyan-600 group-hover:text-white transition-colors duration-300 shadow-sm border border-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="18" height="18" x="3" y="3" rx="2" />
                            <path d="M3 9h18" />
                            <path d="M9 21V9" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-600 text-center">Skip Upload</h3>
                        <p class="text-sm text-slate-400 mt-1 text-center">Proceed to validation table manually</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- STEP 2: VALIDATION (CLEAN TABLE) -->
        <!-- ========================================== -->
        <section *ngIf="currentStep === 'INPUT_SHEET'" class="animate-fade-in flex flex-col gap-6">

            <!-- Validation Summary & Actions -->
            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <div class="flex items-center gap-6">
                    <h3 class="font-bold text-slate-800 text-lg">Data Validation</h3>
                    <!-- LEGEND (Simplified) -->
                    <div
                        class="flex items-center gap-4 text-xs font-medium bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-3 rounded-full bg-red-500"></span>
                            <span class="text-slate-600">Mandatory</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                            <span class="text-slate-600">Calculated</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-3 h-3 rounded-full bg-blue-400"></span>
                            <span class="text-slate-600">Optional</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <!-- Autofill Actions -->
                    <button (click)="autofillDefaults()" title="Fill Orange Fields"
                        class="px-4 py-2.5 rounded-lg border border-orange-200 bg-orange-50 text-orange-700 font-bold hover:bg-orange-100 transition-colors flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Fill Defaults
                    </button>
                    <button (click)="runAiEstimation()" title="Estimate Missing Values"
                        class="px-4 py-2.5 rounded-lg border border-purple-200 bg-purple-50 text-purple-700 font-bold hover:bg-purple-100 transition-colors flex items-center gap-2 text-sm mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        AI Estimate
                    </button>
                    <button (click)="saveAsDraft()"
                        class="px-5 py-2.5 rounded-lg border border-slate-300 text-slate-700 font-bold hover:bg-slate-50 transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save Draft
                    </button>
                    <button (click)="startBspa()"
                        class="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-500/20 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Start BSPA
                    </button>
                </div>
            </div>

            <!-- DETAILED TABLE - REDESIGNED -->
            <div class="modern-panel bg-white overflow-hidden animate-slide-up shadow-md">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <!-- Clustered Headers -->
                        <thead
                            class="bg-slate-100 text-slate-500 uppercase text-xs font-bold border-b border-slate-200">
                            <tr>
                                <th class="p-4 w-[40%]">Parameter</th>
                                <th class="p-4 w-[40%]">Value & Spec</th> <!-- Combined Column -->
                                <th class="p-4 w-[20%] text-right pr-8">Status</th> <!-- Combined Source/Status -->
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <ng-container *ngFor="let group of dataService.parameterGroups">
                                <tr class="bg-slate-50/50">
                                    <td colspan="3"
                                        class="p-2 px-4 font-bold text-slate-800 text-xs tracking-wider border-b border-slate-100">
                                        {{ group.groupName }}
                                    </td>
                                </tr>
                                <tr *ngFor="let param of group.parameters"
                                    class="hover:bg-slate-50 transition-colors group bg-white">

                                    <!-- COLUMN 1: PARAMETER INFO -->
                                    <td class="p-4 align-top">
                                        <div class="flex items-start gap-3">
                                            <!-- Status Indicator Dot -->
                                            <div class="mt-1.5 flex-shrink-0">
                                                <span *ngIf="param.mandatoryStatus === 'mandatory'"
                                                    class="block h-2.5 w-2.5 rounded-full"
                                                    [ngClass]="isMissing(param.id) ? 'bg-red-500 ring-4 ring-red-100' : 'bg-emerald-500'"></span>
                                                <span *ngIf="param.mandatoryStatus === 'semi-mandatory'"
                                                    class="block h-2.5 w-2.5 rounded-full"
                                                    [ngClass]="isMissing(param.id) ? 'bg-orange-500 ring-4 ring-orange-100' : 'bg-emerald-500'"></span>
                                                <span *ngIf="param.mandatoryStatus === 'optional'"
                                                    class="block h-2.5 w-2.5 rounded-full"
                                                    [ngClass]="isMissing(param.id) ? 'bg-blue-400 ring-4 ring-blue-100' : 'bg-emerald-500'"></span>
                                            </div>
                                            <div>
                                                <div class="text-slate-800 font-bold text-sm">{{ param.name }}</div>
                                                <div class="text-slate-400 text-xs mt-0.5 font-mono">{{ param.unit ||
                                                    '-' }}</div>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- COLUMN 2: VALUE + SPEC REF -->
                                    <td class="p-4 align-top">
                                        <div class="max-w-xs">
                                            <!-- Input Field -->
                                            <div class="relative">
                                                <input type="text"
                                                    [ngModel]="dataService.variants[0].values[param.id]?.value"
                                                    (ngModelChange)="updateParamValue(param.id, $event)"
                                                    class="bg-white border text-sm rounded-md px-3 py-2 w-full focus:ring-2 focus:outline-none transition-all shadow-sm font-medium"
                                                    [ngClass]="{
                                                        'border-red-500 focus:border-red-500 focus:ring-red-100': isMissing(param.id) && param.mandatoryStatus === 'mandatory',
                                                        'border-orange-500 focus:border-orange-500 focus:ring-orange-100': isMissing(param.id) && param.mandatoryStatus === 'semi-mandatory',
                                                        'border-blue-300 focus:border-blue-400 focus:ring-blue-100': isMissing(param.id) && param.mandatoryStatus === 'optional',
                                                        'border-slate-300 focus:border-blue-500 focus:ring-blue-100': !isMissing(param.id),
                                                        'text-black font-bold': dataService.variants[0].values[param.id]?.source === 'Input Sheet',
                                                        'text-blue-600 font-medium italic': ['Default', 'Estimated'].includes(dataService.variants[0].values[param.id]?.source || ''),
                                                        'text-slate-600': !['Input Sheet', 'Default', 'Estimated'].includes(dataService.variants[0].values[param.id]?.source || '')
                                                    }" placeholder="Enter value..." />
                                                <!-- Unit Suffix (Optional visual flair) -->
                                                <span *ngIf="param.unit"
                                                    class="absolute right-3 top-2 text-xs text-slate-400 pointer-events-none">
                                                    {{ param.unit }}
                                                </span>
                                            </div>

                                            <!-- Reference Spec (EPC) -->
                                            <div *ngIf="epcNumber && epcValues[param.id] !== undefined"
                                                class="mt-1.5 flex items-center gap-2 text-xs">
                                                <span
                                                    class="text-slate-400 uppercase font-bold tracking-wider text-[10px]">Spec:</span>
                                                <span class="font-mono"
                                                    [ngClass]="isEpcMismatch(param.id) ? 'text-red-600 font-bold bg-red-50 px-1 rounded' : 'text-slate-500'">
                                                    {{ epcValues[param.id] }}
                                                </span>
                                                <span *ngIf="isEpcMismatch(param.id)" class="text-red-500"
                                                    title="Values do not match">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                                        stroke-linejoin="round">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="12" y1="8" x2="12" y2="12"></line>
                                                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                                    </svg>
                                                </span>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- COLUMN 3: STATUS / SOURCE -->
                                    <td class="p-4 align-top text-right pr-8">
                                        <div class="flex flex-col items-end gap-1">
                                            <!-- Source Badge -->
                                            <span
                                                class="px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wide border"
                                                [ngClass]="{
                                                    'bg-slate-100 border-slate-200 text-slate-500': !dataService.variants[0].values[param.id]?.source || dataService.variants[0].values[param.id]?.source === 'Manual',
                                                    'bg-blue-50 border-blue-100 text-blue-600': dataService.variants[0].values[param.id]?.source === 'Input Sheet',
                                                    'bg-purple-50 border-purple-100 text-purple-600': dataService.variants[0].values[param.id]?.source === 'Estimated' || dataService.variants[0].values[param.id]?.source === 'Default'
                                                }">
                                                {{ dataService.variants[0].values[param.id]?.source || 'MANUAL' }}
                                            </span>

                                            <!-- Quick Check -->
                                            <span *ngIf="!isMissing(param.id)"
                                                class="text-emerald-500 text-xs font-bold flex items-center gap-1">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                                    stroke-linejoin="round">
                                                    <polyline points="20 6 9 17 4 12"></polyline>
                                                </svg>
                                                OK
                                            </span>
                                            <span *ngIf="isMissing(param.id) && param.mandatoryStatus === 'mandatory'"
                                                class="text-red-500 text-xs font-bold">Required</span>
                                        </div>
                                    </td>
                                </tr>
                            </ng-container>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- STEP 4 & 5 (MAMBA / RESULTS) -->
        <!-- ========================================== -->
        <section *ngIf="currentStep === 'MAMBA'"
            class="modern-panel p-12 flex flex-col items-center text-center animate-slide-up bg-white relative overflow-hidden">
            <div class="mb-8 z-10">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">Running BSPA Simulation</h2>
                <p class="text-slate-500 max-w-lg mx-auto">Processing your validated input data...</p>
                <p class="text-sm font-bold text-slate-600 mt-2 bg-slate-100 px-3 py-1 rounded inline-block">EPC: {{
                    epcNumber || 'N/A' }}</p>
            </div>
            <div *ngIf="isSimulating" class="flex flex-col items-center gap-6 z-10 py-10">
                <div class="relative w-24 h-24">
                    <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                    <div
                        class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin">
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                </div>
                <div>
                    <p class="text-blue-600 font-bold text-lg animate-pulse">Running Simulation...</p>
                    <p class="text-slate-400 text-sm mt-1">This may take a few moments</p>
                </div>
            </div>
        </section>

        <section *ngIf="currentStep === 'RESULTS'" class="animate-slide-up">
            <div
                class="modern-panel p-8 mb-6 border-l-[6px] bg-white flex justify-between items-center shadow-md border-emerald-500">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800 mb-1">Simulation Successful</h2>
                    <p class="text-slate-500">BSPA simulation completed for EPC: {{ epcNumber }}</p>
                </div>
                <div class="text-right">
                    <button (click)="goToHome()"
                        class="bg-slate-800 text-white px-6 py-3 rounded-lg hover:bg-slate-900 transition-colors">
                        Return to Dashboard
                    </button>
                </div>
            </div>
        </section>

    </main>
</div>